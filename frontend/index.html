<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>Q2API 控制台</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=JetBrains+Mono:wght@400;600&display=swap');
    :root {
      --bg:#f7f7f7;
      --ink:#0f0f0f;
      --muted:#555;
      --line:#dedede;
      --panel:#fff;
      --soft:#f2f2f2;
      --shadow:0 14px 48px rgba(0,0,0,0.08);
      --mono:'JetBrains Mono',ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;
      --sans:'Space Grotesk','Inter','Noto Sans SC',system-ui,-apple-system,sans-serif;
    }
    * { box-sizing:border-box; }
    html,body { height:100%; margin:0; }
    body { background:var(--bg); color:var(--ink); font-family:var(--sans); line-height:1.5; padding:18px; }
    .page { max-width:1280px; margin:0 auto 48px; display:flex; flex-direction:column; gap:16px; }
    .masthead { background:var(--panel); border:1px solid var(--line); padding:16px 18px; box-shadow:var(--shadow); display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .title h1 { margin:0; font-size:24px; letter-spacing:-0.02em; }
    .title p { margin:4px 0 0; color:var(--muted); font-size:13px; }
    .status-bar { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .pill { border:1px solid var(--line); padding:6px 10px; font-size:12px; text-transform:uppercase; letter-spacing:0.08em; background:var(--soft); color:var(--muted); min-width:110px; text-align:center; }
    .pill.ok { color:var(--ink); background:#e7e7e7; }
    .pill.bad { border-style:dashed; }
    .btn { border:1px solid #111; background:#111; color:#fff; padding:9px 12px; font-weight:600; font-size:13px; cursor:pointer; border-radius:2px; transition:transform .1s ease, box-shadow .15s ease; }
    .btn:hover { transform:translateY(-1px); box-shadow:0 10px 26px rgba(0,0,0,0.18); }
    .btn:active { transform:translateY(0); }
    .btn:disabled { opacity:.5; cursor:not-allowed; box-shadow:none; transform:none; }
    .ghost { background:#fff; color:#111; border-color:var(--line); }
    .tabs { display:flex; gap:10px; flex-wrap:wrap; }
    .tab-btn { border:1px solid var(--line); background:#fff; padding:10px 14px; cursor:pointer; font-weight:600; letter-spacing:0.01em; }
    .tab-btn.active { background:#111; color:#fff; border-color:#111; }
    .filter-btn { border:1px solid var(--line); background:#fff; padding:6px 10px; cursor:pointer; font-weight:500; font-size:13px; }
    .filter-btn.active { background:#111; color:#fff; border-color:#111; }
    .tab { display:none; background:var(--panel); border:1px solid var(--line); box-shadow:var(--shadow); padding:16px; }
    .tab.active { display:block; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .field { display:flex; flex-direction:column; gap:6px; flex:1; min-width:200px; }
    .field label { font-size:12px; text-transform:uppercase; letter-spacing:0.08em; color:var(--muted); }
    input, textarea, select { width:100%; border:1px solid var(--line); background:#fdfdfd; color:var(--ink); padding:10px 12px; font-family:var(--sans); font-size:14px; border-radius:2px; transition:border .15s ease, box-shadow .15s ease; }
    input:focus, textarea:focus, select:focus { outline:none; border-color:#111; box-shadow:0 0 0 2px #e5e5e5; }
    textarea { min-height:160px; resize:vertical; font-family:var(--mono); }
    .list { display:flex; flex-direction:column; gap:12px; }
    .card { border:1px solid var(--line); padding:14px; background:#fff; display:flex; flex-direction:column; gap:10px; }
    .card-head { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .badge { border:1px solid var(--line); padding:6px 8px; font-size:12px; background:var(--soft); }
    .meta-grid { display:grid; grid-template-columns:140px 1fr; gap:6px 10px; font-size:13px; }
    .meta-grid .key { color:var(--muted); text-transform:uppercase; letter-spacing:0.08em; font-size:12px; }
    .meta-grid .value { white-space:pre-wrap; word-break:break-word; font-family:var(--mono); }
    .code-block { border:1px dashed var(--line); background:#fafafa; padding:10px; font-family:var(--mono); white-space:pre-wrap; font-size:13px; overflow:hidden; text-overflow:ellipsis; }
    .actions { display:flex; gap:8px; flex-wrap:wrap; }
    .log { max-height:360px; overflow:auto; border:1px solid var(--line); background:#fff; padding:10px; font-family:var(--mono); white-space:pre-wrap; }
    .log div { padding:4px 0; border-bottom:1px solid #f1f1f1; }
    .log div:last-child { border-bottom:none; }
    .status-line { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .small { font-size:12px; color:var(--muted); }
    .toast { position:fixed; bottom:18px; left:18px; padding:10px 14px; border:1px solid #111; background:#111; color:#fff; font-size:14px; box-shadow:0 8px 30px rgba(0,0,0,0.2); opacity:0.95; z-index:50; }
    .toast.light { background:#fff; color:#111; }
    .vstack { display:flex; flex-direction:column; gap:12px; }
    .hidden { display:none; }
    .collapse-toggle { margin-left:auto; }
    .auth-stack { gap:16px; margin-top:10px; }
  </style>
</head>
<body>
  <div class="page">
    <header class="masthead">
      <div class="title">
        <h1>Q2API 控制台</h1>
      </div>
      <div class="status-bar">
        <div class="pill bad" id="authStatus">未验证</div>
        <div class="small" id="authHint">未登录会自动跳转到 /login。</div>
        <button class="ghost btn" id="clearAuth">清除凭证</button>
      </div>
    </header>

    <nav class="tabs">
      <button class="tab-btn active" data-tab="accounts">账号列表</button>
      <button class="tab-btn" data-tab="create">创建账号</button>
      <button class="tab-btn" data-tab="oauth">URL 登录 / 设备授权</button>
      <button class="tab-btn" data-tab="chat">Chat 测试</button>
      <button class="tab-btn" data-tab="logs">操作日志</button>
    </nav>

    <section class="tab active" id="tab-accounts">
      <div class="row" style="justify-content:space-between; align-items:flex-start; gap:8px;">
        <div class="row" style="gap:12px; align-items:center;">
          <h2 style="margin:0;">账号列表</h2>
          <div class="tabs" style="gap:4px;">
            <button class="filter-btn active" data-filter="all">全部</button>
            <button class="filter-btn" data-filter="enabled">已启用</button>
            <button class="filter-btn" data-filter="disabled">已禁用</button>
          </div>
        </div>
        <div class="actions" id="accountActions">
          <button class="ghost btn" id="toggleBatchMode">批量操作</button>
          <button class="ghost btn hidden" id="selectAllAccounts">全选</button>
          <button class="ghost btn hidden" id="deselectAllAccounts">取消全选</button>
          <button class="ghost btn hidden" id="enableSelectedAccounts">启用选中</button>
          <button class="ghost btn hidden" id="disableSelectedAccounts">禁用选中</button>
          <button class="ghost btn" id="reloadAccounts">刷新</button>
        </div>
      </div>
      <div class="list" id="accountList"></div>
    </section>

    <section class="tab" id="tab-create">
      <h2>创建账号</h2>
      <div class="row">
        <div class="field"><label>label</label><input id="new_label" /></div>
        <div class="field"><label>clientId</label><input id="new_clientId" /></div>
      </div>
      <div class="row">
        <div class="field"><label>clientSecret</label><input id="new_clientSecret" type="password" /></div>
        <div class="field"><label>refreshToken</label><input id="new_refreshToken" /></div>
      </div>
      <div class="row">
        <div class="field"><label>accessToken</label><input id="new_accessToken" /></div>
        <div class="field">
          <label>启用</label>
          <select id="new_enabled">
            <option value="true" selected>true</option>
            <option value="false">false</option>
          </select>
        </div>
      </div>
      <div class="field">
        <label>other（JSON，可选）</label>
        <textarea id="new_other" placeholder='{"note":"备注"}'></textarea>
      </div>
      <div class="actions">
        <button class="btn" id="createBtn">创建</button>
      </div>
    </section>

    <section class="tab" id="tab-oauth">
      <h2>URL 登录 / 设备授权</h2>
      <div class="row">
        <div class="field"><label>label（可选）</label><input id="auth_label" /></div>
        <div class="field"><label>登录后启用</label>
          <select id="auth_enabled">
            <option value="true" selected>true</option>
            <option value="false">false</option>
          </select>
        </div>
      </div>
      <div class="vstack auth-stack">
        <div class="actions">
          <button class="btn" id="startAuth">开始登录并等待 token</button>
        </div>
        <div class="status-line">
          <div class="pill bad" id="authState">未开始</div>
          <div class="small" id="authTimer">等待操作</div>
        </div>
        <pre class="code-block" id="auth_info">尚未开始</pre>
      </div>
    </section>

    <section class="tab" id="tab-chat">
      <h2>Chat 测试 (/v1/chat/completions)</h2>
      <div class="row">
        <div class="field"><label>model</label><input id="model" value="claude-sonnet-4" /></div>
        <div class="field"><label>是否流式</label>
          <select id="stream">
            <option value="false">false</option>
            <option value="true">true</option>
          </select>
        </div>
        <div class="field" style="flex:0 0 160px;"><label>&nbsp;</label><button class="btn" id="sendBtn">发送请求</button></div>
      </div>
      <div class="field">
        <label>messages（JSON）</label>
        <textarea id="messages">[
  {"role":"system","content":"你是一个乐于助人的助手"},
  {"role":"user","content":"你好，请讲一个简短的故事\n并分两段输出"}
]</textarea>
      </div>
      <div class="field">
        <label>响应</label>
        <pre class="code-block" id="out"></pre>
      </div>
    </section>

    <section class="tab" id="tab-logs">
      <h2>操作日志</h2>
      <p class="small">记录本地操作和接口反馈。</p>
      <div class="log" id="log"></div>
    </section>
  </div>

<script>
const state = {
  password: localStorage.getItem('adminPassword') || '',
  accounts: [],
  authSession: null,
  authTicker: null,
  authWaitTicker: null,
  logs: [],
  batchMode: false,
  selectedAccounts: new Set(),
  filter: 'all',
};

const els = {
  authStatus: document.getElementById('authStatus'),
  authHint: document.getElementById('authHint'),
  clearAuth: document.getElementById('clearAuth'),
  reloadAccounts: document.getElementById('reloadAccounts'),
  toggleBatchMode: document.getElementById('toggleBatchMode'),
  selectAllAccounts: document.getElementById('selectAllAccounts'),
  deselectAllAccounts: document.getElementById('deselectAllAccounts'),
  enableSelectedAccounts: document.getElementById('enableSelectedAccounts'),
  disableSelectedAccounts: document.getElementById('disableSelectedAccounts'),
  createBtn: document.getElementById('createBtn'),
  accountList: document.getElementById('accountList'),
  authLabel: document.getElementById('auth_label'),
  authEnabled: document.getElementById('auth_enabled'),
  authInfo: document.getElementById('auth_info'),
  authState: document.getElementById('authState'),
  authTimer: document.getElementById('authTimer'),
  startAuth: document.getElementById('startAuth'),
  model: document.getElementById('model'),
  stream: document.getElementById('stream'),
  messages: document.getElementById('messages'),
  sendBtn: document.getElementById('sendBtn'),
  out: document.getElementById('out'),
  log: document.getElementById('log'),
};

function setAuthVisual(status, hint) {
  const pill = els.authStatus;
  pill.classList.remove('ok','bad');
  pill.classList.add(status === 'ok' ? 'ok' : 'bad');
  pill.textContent = status === 'ok' ? '已验证' : '未验证';
  if (hint) els.authHint.textContent = hint;
}

function log(message) {
  const ts = new Date().toLocaleTimeString();
  state.logs.unshift(`[${ts}] ${message}`);
  state.logs = state.logs.slice(0, 120);
  els.log.innerHTML = state.logs.map(entry => `<div>${escapeHtml(entry)}</div>`).join('');
}

function escapeHtml(str) { return String(str).replace(/[&<>]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c])); }

function toast(msg, light=false) {
  const d = document.createElement('div');
  d.className = 'toast' + (light ? ' light' : '');
  d.textContent = msg;
  document.body.appendChild(d);
  setTimeout(() => { d.style.opacity = '0'; d.style.transition = 'opacity .2s'; setTimeout(()=>d.remove(), 250); }, 1800);
}

function getAuthHeaders() { return state.password ? { 'Authorization': `Bearer ${state.password}` } : {}; }

function handleAuthLoss(reason) {
  state.password = '';
  localStorage.removeItem('adminPassword');
  setAuthVisual('bad', reason || '凭证无效，正在跳转登录页。');
  toast('需要重新登录');
  setTimeout(() => { window.location.href = '/login'; }, 400);
}

async function authFetch(url, options = {}) {
  const headers = { ...getAuthHeaders(), ...(options.headers || {}) };
  const resp = await fetch(url, { ...options, headers });
  if (resp.status === 401) {
    handleAuthLoss('后台返回 401，未自动跳转。');
    throw new Error('未通过后台密码');
  }
  return resp;
}

function setBusy(btn, busy, text) {
  if (!btn) return;
  if (busy) { btn.dataset.prev = btn.textContent; btn.textContent = text || '进行中...'; btn.disabled = true; }
  else { btn.textContent = btn.dataset.prev || btn.textContent; btn.disabled = false; }
}

function maskSecret(val) {
  if (!val) return '—';
  const tail = String(val).slice(-4);
  return `***${tail} (len ${String(val).length})`;
}

async function loadAccounts() {
  if (!state.password) { setAuthVisual('bad', '未验证，先去登录页。'); return; }
  els.accountList.innerHTML = '<div class="small">加载中...</div>';
  try {
    const r = await authFetch(api('/v2/accounts'));
    if (!r.ok) throw new Error(await r.text());
    const data = await r.json();
    state.accounts = Array.isArray(data) ? data : [];
    renderAccounts();
    log(`已载入 ${state.accounts.length} 个账号`);
  } catch (e) {
    els.accountList.innerHTML = `<div class="small">加载失败：${escapeHtml(e.message)}</div>`;
    log(`拉取账号失败: ${e.message}`);
  }
}

function renderAccounts() {
  const root = els.accountList;
  root.innerHTML = '';
  if (!state.accounts.length) { root.innerHTML = '<div class="small">暂无账号</div>'; return; }
  let filtered = state.accounts;
  if (state.filter === 'enabled') filtered = state.accounts.filter(a => a.enabled);
  else if (state.filter === 'disabled') filtered = state.accounts.filter(a => !a.enabled);
  if (!filtered.length) { root.innerHTML = '<div class="small">无匹配账号</div>'; return; }
  filtered.forEach(acc => root.appendChild(buildAccountCard(acc)));
}

function setFilter(filter) {
  state.filter = filter;
  document.querySelectorAll('[data-filter]').forEach(btn => btn.classList.toggle('active', btn.dataset.filter === filter));
  renderAccounts();
}

function formatMultiline(val) {
  if (val === null || val === undefined || val === '') return '—';
  if (typeof val === 'object') return JSON.stringify(val, null, 2);
  return String(val);
}

function buildAccountCard(acc) {
  const card = document.createElement('article'); card.className = 'card';
  card.style.cursor = 'pointer';
  if (state.batchMode && state.selectedAccounts.has(acc.id)) {
    card.style.borderColor = '#111';
    card.style.borderWidth = '2px';
  }
  const head = document.createElement('div'); head.className = 'card-head';

  // Checkbox for batch mode
  if (state.batchMode) {
    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.checked = state.selectedAccounts.has(acc.id);
    checkbox.style.width = '18px';
    checkbox.style.height = '18px';
    checkbox.style.cursor = 'pointer';
    checkbox.onclick = (e) => { e.stopPropagation(); toggleAccountSelection(acc.id); };
    head.appendChild(checkbox);
  }

  const title = document.createElement('div'); title.style.fontWeight = '700'; title.textContent = acc.label || '未命名';
  const badge = document.createElement('div'); badge.className = 'badge mono'; badge.textContent = acc.id;
  const enabled = document.createElement('div'); enabled.className = 'pill ' + (acc.enabled ? 'ok' : 'bad'); enabled.textContent = acc.enabled ? 'Enabled' : 'Disabled';
  const toggle = document.createElement('button'); toggle.className = 'ghost btn'; toggle.textContent = acc.enabled ? '禁用' : '启用';
  toggle.onclick = () => updateAccount(acc.id, { enabled: !acc.enabled }, toggle, acc.enabled ? '禁用中...' : '启用中...');
  const refresh = document.createElement('button'); refresh.className = 'ghost btn'; refresh.textContent = '刷新 Token'; refresh.onclick = () => refreshAccount(acc.id, refresh);
  const collapseBtn = document.createElement('button'); collapseBtn.className = 'ghost btn collapse-toggle'; collapseBtn.textContent = '展开详情';
  head.append(title, badge, enabled, refresh, toggle, collapseBtn); card.appendChild(head);

  const detail = document.createElement('div'); detail.className = 'vstack hidden';

  const meta = document.createElement('div'); meta.className = 'meta-grid';
  const rows = [
    ['clientId', acc.clientId],
    ['clientSecret', maskSecret(acc.clientSecret)],
    ['refreshToken', acc.refreshToken ? '[已填]' : '—'],
    ['accessToken', acc.accessToken ? '[已填]' : '—'],
    ['success', acc.success_count ?? 0],
    ['error', acc.error_count ?? 0],
    ['last_refresh', acc.last_refresh_time || 'never'],
    ['last_status', acc.last_refresh_status || '—'],
    ['created_at', acc.created_at],
    ['updated_at', acc.updated_at],
  ];
  rows.forEach(([k,v]) => {
    const kEl = document.createElement('div'); kEl.className = 'key'; kEl.textContent = k;
    const vEl = document.createElement('div'); vEl.className = 'value'; vEl.textContent = formatMultiline(v);
    meta.append(kEl, vEl);
  });
  detail.appendChild(meta);

  if (acc.other) {
    const other = document.createElement('div'); other.className = 'code-block'; other.textContent = formatMultiline(acc.other); detail.appendChild(other);
  }

  const editRow = document.createElement('div'); editRow.className = 'row';
  const labelBox = document.createElement('div'); labelBox.className = 'field';
  const labelLabel = document.createElement('label'); labelLabel.textContent = 'label';
  const labelInput = document.createElement('input'); labelInput.value = acc.label || '';
  labelBox.append(labelLabel, labelInput);
  const accessBox = document.createElement('div'); accessBox.className = 'field';
  const accessLabel = document.createElement('label'); accessLabel.textContent = 'accessToken (快速更新，可选)';
  const accessInput = document.createElement('input'); accessInput.value = acc.accessToken || '';
  accessBox.append(accessLabel, accessInput);
  editRow.append(labelBox, accessBox); detail.appendChild(editRow);

  const actions = document.createElement('div'); actions.className = 'actions';
  const save = document.createElement('button'); save.className = 'ghost btn'; save.textContent = '保存';
  save.onclick = () => updateAccount(acc.id, { label: labelInput.value, accessToken: accessInput.value }, save, '保存中...');
  const del = document.createElement('button'); del.className = 'ghost btn'; del.textContent = '删除'; del.onclick = () => deleteAccount(acc.id, del);
  actions.append(save, del); detail.appendChild(actions);

  collapseBtn.onclick = (e) => {
    e.stopPropagation();
    const isHidden = detail.classList.contains('hidden');
    detail.classList.toggle('hidden', !isHidden);
    collapseBtn.textContent = isHidden ? '收起详情' : '展开详情';
  };

  // Card click handler: batch mode = select/deselect, normal mode = toggle details
  card.onclick = (e) => {
    if (e.target.tagName === 'BUTTON' || e.target.tagName === 'INPUT') return;
    if (state.batchMode) {
      toggleAccountSelection(acc.id);
    } else {
      const isHidden = detail.classList.contains('hidden');
      detail.classList.toggle('hidden', !isHidden);
      collapseBtn.textContent = isHidden ? '收起详情' : '展开详情';
    }
  };

  card.appendChild(detail);
  return card;
}

async function updateAccount(id, patch, btn, busyText) {
  if (!state.password) return handleAuthLoss('请先登录页验证密码');
  setBusy(btn, true, busyText || '更新中...');
  try {
    const r = await authFetch(api('/v2/accounts/' + encodeURIComponent(id)), { method:'PATCH', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(patch) });
    if (!r.ok) throw new Error(await r.text());
    toast('已更新账号'); await loadAccounts();
  } catch (e) { toast('更新失败: ' + e.message, true); log('更新账号失败: ' + e.message); }
  finally { setBusy(btn, false); }
}

async function batchUpdateAccounts(enabled, btn) {
  if (!state.password) return handleAuthLoss('请先登录页验证密码');
  if (!state.selectedAccounts.size) { toast('请先选择账号', true); return; }

  const action = enabled ? '启用' : '禁用';
  if (!confirm(`确认${action}选中的 ${state.selectedAccounts.size} 个账号？`)) return;

  setBusy(btn, true, `${action}中...`);
  try {
    const r = await authFetch(api('/v2/accounts/batch'), {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ account_ids: Array.from(state.selectedAccounts), enabled: enabled })
    });
    if (!r.ok) throw new Error(await r.text());
    const result = await r.json();
    toast(`已${action} ${result.updated_count} 个账号`);
    state.selectedAccounts.clear();
    await loadAccounts();
  } catch (e) {
    toast(`批量${action}失败: ` + e.message, true);
    log(`批量${action}失败: ` + e.message);
  } finally {
    setBusy(btn, false);
  }
}

function toggleBatchMode() {
  state.batchMode = !state.batchMode;
  state.selectedAccounts.clear();
  els.toggleBatchMode.textContent = state.batchMode ? '退出批量' : '批量操作';
  els.selectAllAccounts.classList.toggle('hidden', !state.batchMode);
  els.deselectAllAccounts.classList.toggle('hidden', !state.batchMode);
  els.enableSelectedAccounts.classList.toggle('hidden', !state.batchMode);
  els.disableSelectedAccounts.classList.toggle('hidden', !state.batchMode);
  renderAccounts();
}

function selectAllAccounts() {
  state.accounts.forEach(acc => state.selectedAccounts.add(acc.id));
  renderAccounts();
}

function deselectAllAccounts() {
  state.selectedAccounts.clear();
  renderAccounts();
}

function toggleAccountSelection(id) {
  if (state.selectedAccounts.has(id)) {
    state.selectedAccounts.delete(id);
  } else {
    state.selectedAccounts.add(id);
  }
  renderAccounts();
}

async function refreshAccount(id, btn) {
  if (!state.password) return handleAuthLoss('请先登录页验证密码');
  setBusy(btn, true, '刷新中...');
  try {
    const r = await authFetch(api('/v2/accounts/' + encodeURIComponent(id) + '/refresh'), { method:'POST' });
    if (!r.ok) throw new Error(await r.text());
    toast('已触发刷新'); await loadAccounts();
  } catch (e) { toast('刷新失败: ' + e.message, true); }
  finally { setBusy(btn, false); }
}

async function deleteAccount(id, btn) {
  if (!confirm('确认删除该账号？')) return;
  setBusy(btn, true, '删除中...');
  try {
    const r = await authFetch(api('/v2/accounts/' + encodeURIComponent(id)), { method:'DELETE' });
    if (!r.ok) throw new Error(await r.text());
    toast('已删除'); await loadAccounts();
  } catch (e) { toast('删除失败: ' + e.message, true); }
  finally { setBusy(btn, false); }
}

async function createAccount() {
  if (!state.password) return handleAuthLoss('请先登录页验证密码');
  const body = {
    label: document.getElementById('new_label').value.trim() || null,
    clientId: document.getElementById('new_clientId').value.trim(),
    clientSecret: document.getElementById('new_clientSecret').value.trim(),
    refreshToken: document.getElementById('new_refreshToken').value.trim() || null,
    accessToken: document.getElementById('new_accessToken').value.trim() || null,
    enabled: document.getElementById('new_enabled').value === 'true',
    other: (()=>{ const t=document.getElementById('new_other').value.trim(); if(!t) return null; try { return JSON.parse(t); } catch { alert('other 不是合法 JSON'); throw new Error('bad other'); } })()
  };
  setBusy(els.createBtn, true, '提交中...');
  try {
    const r = await authFetch(api('/v2/accounts'), { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(body) });
    if (!r.ok) throw new Error(await r.text());
    toast('创建成功'); log('创建账号成功'); await loadAccounts();
  } catch (e) { toast('创建失败: ' + e.message, true); log('创建账号失败: ' + e.message); }
  finally { setBusy(els.createBtn, false); }
}

function api(path) { return ('/' + (path || '').replace(/^\/+/,'')).replace(/\/{2,}/g, '/'); }

function resetAuthSessionTimers() { if (state.authTicker) { clearInterval(state.authTicker); state.authTicker=null; } if (state.authWaitTicker) { clearInterval(state.authWaitTicker); state.authWaitTicker=null; } }

function updateAuthInfo(text, cls, timerText, stateText) {
  els.authInfo.textContent = text;
  els.authState.classList.remove('ok','bad');
  if (cls) els.authState.classList.add(cls);
  if (stateText) {
    els.authState.textContent = stateText;
  } else {
    els.authState.textContent = cls === 'ok' ? '进行中' : '未开始';
  }
  if (timerText) els.authTimer.textContent = timerText;
}

async function startDeviceAuth() {
  if (!state.password) return handleAuthLoss('请先登录页验证密码');
  resetAuthSessionTimers(); setBusy(els.startAuth, true, '启动中...'); updateAuthInfo('请求中...', 'bad', '准备获取链接', '启动中');
  try {
    const body = { label: (els.authLabel.value || '').trim() || null, enabled: els.authEnabled.value === 'true' };
    const r = await authFetch(api('/v2/auth/start'), { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(body) });
    if (!r.ok) throw new Error(await r.text());
    const j = await r.json();
    state.authSession = { ...j, startedAt: Date.now(), label: body.label, enabled: body.enabled };
    updateAuthInfo(
`验证链接: ${j.verificationUriComplete || ''}\n用户代码: ${j.userCode || ''}\nauthId: ${j.authId}\nexpiresIn: ${j.expiresIn}s\ninterval: ${j.interval}s`,
      'ok', '已生成验证链接，手动打开完成登录。', '等待授权'
    );
    log('已生成设备授权链接');
    const maxMs = (j.maxTimeout ? Number(j.maxTimeout) * 1000 : 300000);
    const deadline = Date.now() + Math.min(maxMs, (j.expiresIn || 600) * 1000);
    state.authTicker = setInterval(() => {
      const left = Math.max(0, deadline - Date.now());
      els.authTimer.textContent = `剩余 ${(left/1000).toFixed(0)} 秒可完成验证`;
      if (left <= 0) resetAuthSessionTimers();
    }, 1000);
    // 自动进入等待领取 token，无需手动点击
    claimDeviceAuth(true);
  } catch (e) {
    updateAuthInfo('启动失败：' + e.message, 'bad', '重试即可', '失败'); toast('启动登录失败: ' + e.message, true);
  } finally { setBusy(els.startAuth, false); }
}

async function claimDeviceAuth(auto=false) {
  if (!state.authSession || !state.authSession.authId) { updateAuthInfo('请先点击“开始登录”获取 authId', 'bad', '无有效会话'); return; }
  resetAuthSessionTimers(); const start = Date.now();
  state.authWaitTicker = setInterval(() => { const elapsed=((Date.now()-start)/1000).toFixed(0); els.authTimer.textContent = `等待授权中 · 已用 ${elapsed}s`; }, 1000);
  try {
    const r = await authFetch(api('/v2/auth/claim/' + encodeURIComponent(state.authSession.authId)), { method:'POST' });
    const text = await r.text(); let j; try { j = JSON.parse(text); } catch { j = { raw: text }; }
    if (!r.ok) throw new Error(j.detail || text);
    updateAuthInfo('完成：\n' + JSON.stringify(j, null, 2), 'ok', 'token 已获取，列表会自动刷新', '已完成');
    log('设备授权完成'); await loadAccounts();
  } catch (e) { updateAuthInfo('失败：' + e.message, 'bad', '请重新开始', '失败'); toast('领取失败: ' + e.message, true); }
  finally { resetAuthSessionTimers(); if (!auto) { /* no button to reset */ } }
}

async function sendChat() {
  if (!state.password) return handleAuthLoss('请先登录页验证密码');
  els.out.textContent = ''; let messages;
  try { messages = JSON.parse(els.messages.value); } catch (e) { els.out.textContent = 'messages 不是合法 JSON'; return; }
  const body = { model: els.model.value.trim(), messages, stream: els.stream.value === 'true' };
  const headers = { 'Content-Type': 'application/json' }; setBusy(els.sendBtn, true, '发送中...');
  try {
    if (!body.stream) {
      const r = await authFetch(api('/v1/chat/completions'), { method:'POST', headers, body: JSON.stringify(body) }); const text = await r.text();
      try { els.out.textContent = JSON.stringify(JSON.parse(text), null, 2); } catch { els.out.textContent = text; }
    } else {
      const r = await authFetch(api('/v1/chat/completions'), { method:'POST', headers, body: JSON.stringify(body) });
      const reader = r.body.getReader(); const decoder = new TextDecoder();
      while (true) { const {value, done} = await reader.read(); if (done) break; els.out.textContent += decoder.decode(value, {stream:true}); }
    }
  } catch (e) { els.out.textContent = '请求失败：' + e.message; }
  finally { setBusy(els.sendBtn, false); }
}

function switchTab(name) {
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.dataset.tab === name));
  document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.id === 'tab-' + name));
}

function bootstrap() {
  document.querySelectorAll('.tab-btn').forEach(btn => btn.addEventListener('click', () => switchTab(btn.dataset.tab)));
  document.querySelectorAll('[data-filter]').forEach(btn => btn.addEventListener('click', () => setFilter(btn.dataset.filter)));
  els.toggleBatchMode.addEventListener('click', toggleBatchMode);
  els.selectAllAccounts.addEventListener('click', selectAllAccounts);
  els.deselectAllAccounts.addEventListener('click', deselectAllAccounts);
  els.enableSelectedAccounts.addEventListener('click', () => batchUpdateAccounts(true, els.enableSelectedAccounts));
  els.disableSelectedAccounts.addEventListener('click', () => batchUpdateAccounts(false, els.disableSelectedAccounts));
  els.reloadAccounts.addEventListener('click', loadAccounts);
  els.createBtn.addEventListener('click', createAccount);
  els.startAuth.addEventListener('click', startDeviceAuth);
  els.sendBtn.addEventListener('click', sendChat);
  els.clearAuth.addEventListener('click', () => { handleAuthLoss('手动清除凭证'); });

  if (state.password) {
    setAuthVisual('ok', '已从本地读取密码，可直接操作。'); loadAccounts();
  } else {
    setAuthVisual('bad', '未验证，自动跳转登录页。');
    window.location.href = '/login';
  }
}

document.addEventListener('DOMContentLoaded', bootstrap);
</script>
</body>
</html>
